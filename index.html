<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Terabox Download & Watch</title>
    <style>
        body {
            text-align: center;
            background-color: rgb(149, 144, 144);
        }
        button {
            background-color: #62529c;
            border: none;
            color: #fff;
            padding: 6px 10px;
            text-decoration: none;
            margin: 4px 2px;
            cursor: pointer;
        }
        button:hover {
            background-color: #7d70ae;
        }
        input[type=text] {
            width: 50%;
            padding: 5px;
            border: 2px solid #cccccc;
            border-radius: 5px;
        }
        input[type=text]:focus {
            border-color: #333333;
        }
        #message {
            margin-top: 10px;
            color: red;
        }
        video {
            margin-top: 20px;
            max-width: 90%;
            height: auto;
        }
    </style>
</head>
<body>
    <h2>Enter URL for Terabox</h2>
    <small><b>Enter URL of Terabox</b></small>
    <br />
    <input type="text" id="url" placeholder="https://teraboxapp.com/s/1ydUjaL5-asArd-ew">
    <button onclick="handleClick()">Fetch</button>
    <p id="message"></p>
    <video id="videoPlayer" controls style="display: none;"></video>
    <button id="downloadButton" style="display: none;" onclick="downloadMedia()">Download</button>

    <script defer>
        function isValidUrl(url) {
            const pattern = new RegExp('^(https?:\\/\\/)?' +
                '((([a-z\\d]([a-z\\d-]*[a-z\\d])*)\\.?)+[a-z]{2,}|'+
                '((\\d{1,3}\\.){3}\\d{1,3}))' +
                '(\\:\\d+)?(\\/[-a-z\\d%_.~+]*)*' +
                '(\\?[;&a-z\\d%_.~+=-]*)?' +
                '(\\#[-a-z\\d_]*)?$','i');
            return !!pattern.test(url);
        }

        let downloadLink = "";

        async function handleClick() {
            const urlInput = document.querySelector("#url").value;
            const messageEl = document.querySelector("#message");
            const videoPlayer = document.querySelector("#videoPlayer");
            const downloadButton = document.querySelector("#downloadButton");

            // Reset the UI
            messageEl.textContent = "";
            videoPlayer.style.display = "none";
            downloadButton.style.display = "none";

            if (!isValidUrl(urlInput)) {
                messageEl.textContent = "Invalid URL. Please enter a valid Terabox URL.";
                return;
            }

            const urlParts = urlInput.split("/");
            const value = urlParts[urlParts.length - 1]?.slice(1);
            const preUrl = `https://terabox-backend.onrender.com/get_data?url=${value}`;

            try {
                const response = await fetch(preUrl);
                if (!response.ok) throw new Error("Failed to fetch the download link.");
                const data = await response.json();

                if (data.list && data.list[0]?.dlink) {
                    downloadLink = data.list[0].dlink;

                    // Show the media player with the fetched link
                    videoPlayer.src = downloadLink;
                    videoPlayer.style.display = "block";

                    // Show the download button
                    downloadButton.style.display = "inline-block";
                } else {
                    throw new Error("No media found at the provided link.");
                }
            } catch (error) {
                messageEl.textContent = error.message;
                console.error(error);
            }
        }

        function downloadMedia() {
            if (downloadLink) {
                window.location.href = downloadLink;
            } else {
                alert("No media link available to download.");
            }
        }
    </script>
</body>
</html>
